<% include ../../parts/head %>

<link rel="stylesheet" href="/media/dashboard/css/chosen.css" />

<% include ../../parts/bodyStart %>

<div id="entity-create">
    <p class="head">
        <i class="icon-briefcase"></i> Sponsor Page:
    </p>

    <form action="/dashboard/sponsor/page" method="post" id="create-team-form" class="form-horizontal">
        <div class="control-group">
            <label class="control-label" for="name">Name:</label>
            <div class="controls">
                <input tabindex="1" name="name" id="name" <% if (page != undefined) { %>value="<%= page.get('name') %>"<% } %>/>
                <span class="input-required">*required</span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="speciality">Speciality:</label>
            <div class="controls">
                <input tabindex="2" name="speciality" id="speciality" <% if (page != undefined) { %>value="<%= page.get('speciality') %>"<% } %>/>
                <span class="input-required">*required</span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="form-field-phone">Phone:</label>
            <div class="controls">
                <span class="input-icon input-icon-right">
                    <input tabindex="3" class="input-medium input-mask-phone" name="phone" id="form-field-phone" type="text"
                            <% if (page != undefined) { %>value="<%= page.get('phone') %>"<% } %>>
                    <i class="icon-phone icon-flip-horizontal icon-right"></i>
                </span>
                <span class="input-required">*required</span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="form-field-fax">Fax:</label>
            <div class="controls">
                <span class="input-icon input-icon-right">
                    <input tabindex="4" class="input-medium input-mask-phone" name="fax" id="form-field-fax" type="text"
                            <% if (page != undefined) { %>value="<%= page.get('fax') %>"<% } %>>
                    <i class="icon-phone icon-flip-horizontal icon-right"></i>
                </span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="email">Email:</label>

            <div class="controls">
                <span class="input-icon input-icon-right">
                    <input tabindex="5" class="input-medium input-mask-email" id="email" name="email" type="email" placeholder="me@website.com"
                        <% if (page != undefined) { %>value="<%= page.get('email') %>"<% } %>>
                    <i class="icon-envelope"></i>
                </span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="form-field-website">Website:</label>
            <div class="controls">
                <span class="input-icon input-icon-right">
                    <input tabindex="6" class="input-medium input-mask-website" name="website" id="form-field-website" type="url" placeholder="http://www.website.com"
                            <% if (page != undefined) { %>value="<%= page.get('website') %>"<% } %>>
                    <i class="icon-bookmark icon-flip-horizontal icon-for-not-required-field"></i>
                </span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="form-field-video">Video:</label>
            <div class="controls">
                <span class="input-icon input-icon-right">
                    <input tabindex="7" class="input-medium input-mask-website" name="video" id="form-field-video" type="url"
                            <% if (page != undefined) { %>value="<%= page.get('video') %>"<% } %>>
                    <i class="icon-facetime-video icon-for-not-required-field"></i>
                </span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="description">Description:</label>
            <div class="controls">
                <textarea name="description" id="description" rows="5"><% if (page != undefined) { %>value="<%= page.get('description') %>"<% } %></textarea>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="location">Location:</label>
            <div class="controls">
                <input id="location" name="location" class="controls" type="text" placeholder="Enter a location">
                <input id="infoLat" name="infoLat" type="hidden"
                    <% if (lat != undefined) { %>value="<%= lat %>"<% } %>>
                <input id="infoLng" name="infoLng" type="hidden"
                    <% if (lng != undefined) { %>value="<%= lng %>"<% } %>>
                <input id="infoWindow" name="infoWindow" type="hidden"
                    <% if (infoWindow != undefined) { %>value="<%= infoWindow %>"<% } %>>
                <div id="map_canvas" class="google-map-canvas"></div>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="offer-image-input1">Thumbnail:</label>
            <div class="controls ace-files-container">
                <% if (page != undefined && page.get('thumbnail')) { %>
                    <div class="thumbnail" data-thumbnail-index="4">
                        <img src="<%= page.get('thumbnail') %>"/>
                        <div class="remove-image-container">
                            <a href="javascript:void(0);" class="btn btn-small btn-danger">Remove</a>
                        </div>
                    </div>
                <% } %>
                <input type="hidden" name="thumbnail" />
                <input type="file" id="offer-image-input4" name="offerImageInput4" class="file-upload-input" accept="image/*" />
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="offer-image-input1">Images:</label>
            <div class="controls ace-files-container" name="offerImagesContainer">
                <% if (page != undefined && page.get('images').length) { %>
                    <% page.get('images').forEach(function(image, index) { %>
                        <div class="thumbnail" data-thumbnail-index="<%= index + 1 %>">
                            <img src="<%= image %>"/>
                            <div class="remove-image-container">
                                <a href="javascript:void(0);" class="btn btn-small btn-danger">Remove</a>
                            </div>
                        </div>
                    <% }) %>
                <% } %>

                <input type="hidden" name="offerImage1" />
                <input type="file" id="offer-image-input1" name="offerImageInput1" class="file-upload-input" accept="image/*" />
                <input type="hidden" name="offerImage2" />
                <input type="file" id="offer-image-input2" name="offerImageInput2" class="file-upload-input" accept="image/*" />
                <input type="hidden" name="offerImage3" />
                <input type="file" id="offer-image-input3" name="offerImageInput3" class="file-upload-input" accept="image/*" />
                <div class="save-btn-container">
                    <div class="save-btn-inner-container">
                        <button class="btn btn-danger" type="submit">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<% include ../../parts/scripts %>

<script src="/media/dashboard/js/jquery.validate.js"></script>
<script src="/media/dashboard/js/additional-methods.min.js"></script>
<script src="/media/dashboard/js/jquery.validate.spudder.rules.js"></script>
<script src="/media/dashboard/js/date-time/bootstrap-datepicker.min.js"></script>
<script src="/media/dashboard/js/teams/helpers.js"></script>
<script src="/media/js/parse.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=<%= keys.placesAPIKey %>&v=3.exp&sensor=false&libraries=places"></script>

<script>
    function initialize() {
        function addPlaceChangedListener() {
            google.maps.event.addListener(autocomplete, 'place_changed', function () {
                infowindow.close();
                marker.setVisible(false);

                var place = autocomplete.getPlace();
                if (!place.geometry) return;

                var location = place.geometry.location;

                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setCenter(location);
                    map.setZoom(17);  // Why 17? Because it looks good.
                }

                marker.setPosition(location);
                marker.setVisible(true);

                var address = '';
                if (place.address_components) {
                    address = [
                        (place.address_components[0] && place.address_components[0].short_name || ''),
                        (place.address_components[1] && place.address_components[1].short_name || ''),
                        (place.address_components[2] && place.address_components[2].short_name || '')
                    ].join(' ');
                }

                var infoWindowContent = '<div><strong>' + place.name + '</strong><br>' + address +
                        '<br><a href="http://maps.google.com/?q=' + encodeURIComponent(address) + '" target="_new">External map</a>';
                infowindow.setContent(infoWindowContent);
                infowindow.open(map, marker);

                inputInfoWindow.value = infoWindowContent;
                inputLat.value = location.d;
                inputLng.value = location.e;
            });
        }

        function addKeyDownListener() {
            google.maps.event.addDomListener(input, 'keydown', function (event) { // Prevent form submit event on Enter
                if (event.keyCode == 13) {
                    if (event.preventDefault) {
                        event.preventDefault();
                    } else {
                        event.cancelBubble = true;
                        event.returnValue = false;
                    }
                }
            });
        }

        function placeStartMarker (address, mapInfo) {
            var geocoder = new google.maps.Geocoder(),
                infoContent = mapInfo.split(';')[2];

            geocoder.geocode( { 'address': address}, function(results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    var location = results[0].geometry.location;

                    map.setCenter(location);
                    map.setZoom(13);

                    marker.setPosition(location);
                    marker.setVisible(true);

                    infowindow.setContent(infoContent);
                    input.value = address;
                    infowindow.open(map, marker);
                }
            });
        }

        var mapOptions = {
                zoom: 6, center: new google.maps.LatLng(-34.397, 150.644),
                    mapTypeControl: false, streetViewControl: false
            },
            canvas = document.getElementById('map_canvas'),
            map = new google.maps.Map(canvas, mapOptions),
            input = (document.getElementById('location')),
            inputLat = (document.getElementById('infoLat')),
            inputLng = (document.getElementById('infoLng')),
            inputInfoWindow = (document.getElementById('infoWindow'));

        addKeyDownListener();

        map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

        var autocomplete = new google.maps.places.Autocomplete(input);
        window.autocomplete = autocomplete;
        autocomplete.bindTo('bounds', map);

        var infowindow = new google.maps.InfoWindow(),
            marker = new google.maps.Marker({ map: map });

        addPlaceChangedListener();

        <% if (page != undefined && page.get('location') != "") { %>
            placeStartMarker('<%- page.get('location') %>', '<%- page.get('mapInfo') %>');
        <% } %>
    }

    google.maps.event.addDomListener(window, 'load', initialize);
</script>
<script>
    $(window).load(function () {
        <% if (page != undefined) { %>
            $('.controls.ace-files-container').each(function () {
                if ($(this).find('.thumbnail:visible').length) {
                    $(this).find('.ace-file-input, .save-btn-container').addClass('below-thumbnail');
                }
            });

//            $('.ace-file-input, .save-btn-container').addClass('below-thumbnail');

            $('.thumbnail').each(function () {
                var $removeButton = $(this).find('a'),
                    index = parseInt($(this).data('thumbnail-index'), 10),
                    $aceFileInput = $('#offer-image-input' + index).parent();

                $aceFileInput.hide();

                $removeButton.click(function () {
                    var $self = $(this),
                        $thumbnail = $self.parent().parent(),
                        index = parseInt($thumbnail.data('thumbnail-index'), 10),
                        $aceFileInput = $('#offer-image-input' + index).parent();

                    $thumbnail.hide();
                    $aceFileInput.show();

                    $('.controls.ace-files-container').each(function () {
                        if ($(this).find('.thumbnail:visible').length == 0) {
                            $(this).find('.ace-file-input, .save-btn-container').removeClass('below-thumbnail');
                        }
                    });
                });
            });
        <% } %>
    });

    $(document).ready(function () {
        Parse.initialize('<%= keys.appId %>', '<%= keys.jsKey %>');

        var $form = $('#create-team-form');

        $form.validate({
            rules: {
                name: "required",
                speciality: "required",
                phone: { required: true, phoneUS: true },
                fax: { phoneUS: true },
                offerImageInput1: { extension: "gif|png|jpg|jpeg" },
                offerImageInput2: { extension: "gif|png|jpg|jpeg" },
                offerImageInput3: { extension: "gif|png|jpg|jpeg" }
            },
            errorPlacement: function(error, element) {
                if (error.text() == "Both location name and position has to be filled (selected).") {
                    error.insertBefore('#location-canvas');
                } else {
                    error.appendTo( element.parent() );
                }
            },
            submitHandler: function (form) {
                var $formSubmit = $(form).find('button[type="submit"]');

                $formSubmit.text('Saving...');
                $formSubmit.attr('disabled', 'disabled');

                var offerImage1 = $(form).find('input[name="offerImage1"]'),
                    fileUploadControl1 = $("#offer-image-input1")[0],
                    $thumbnail1 = $(form).find('.thumbnail[data-thumbnail-index="1"]'),
                    offerImage2 = $(form).find('input[name="offerImage2"]'),
                    fileUploadControl2 = $("#offer-image-input2")[0],
                    $thumbnail2 = $(form).find('.thumbnail[data-thumbnail-index="2"]'),
                    offerImage3 = $(form).find('input[name="offerImage3"]'),
                    fileUploadControl3 = $("#offer-image-input3")[0],
                    $thumbnail3 = $(form).find('.thumbnail[data-thumbnail-index="3"]'),
                    thumbnail = $(form).find('input[name="thumbnail"]'),
                    thumbnailControl = $("#offer-image-input4")[0],
                    $thumbnail4 = $(form).find('.thumbnail[data-thumbnail-index="4"]');

                var deffers = [ new jQuery.Deferred(), new jQuery.Deferred(), new jQuery.Deferred(), new jQuery.Deferred() ],
                    promises =  [deffers[0].promise(), deffers[1].promise(), deffers[2].promise(), deffers[3].promise() ];

                if ($thumbnail1.is(':visible')) {
                    offerImage1.val($thumbnail1.find('img').attr('src'));
                    deffers[0].resolve();
                } else if (fileUploadControl1.files.length > 0) {
                    var file1 = fileUploadControl1.files[0],
                        fileName1 = file1.name;

                    var parseFile1 = new Parse.File(fileName1, file1);
                    parseFile1.save().then(function(image) {
                        offerImage1.val(image.url());
                        deffers[0].resolve();
                    }, function(error) {
                        console.log(error);
                    });
                } else {
                    deffers[0].resolve();
                }

                $.when(promises[0]).then(function () {
                    if ($thumbnail2.is(':visible')) {
                        offerImage2.val($thumbnail2.find('img').attr('src'));
                        deffers[1].resolve();
                    } else if (fileUploadControl2.files.length > 0) {
                        var file2 = fileUploadControl2.files[0],
                            fileName2 = file2.name;

                        var parseFile2 = new Parse.File(fileName2, file2);
                        parseFile2.save().then(function(image) {
                            offerImage2.val(image.url());
                            deffers[1].resolve();
                        }, function(error) {
                            console.log(error);
                        });
                    } else {
                        deffers[1].resolve();
                    }
                });

                $.when(promises[1]).then(function () {
                    if ($thumbnail3.is(':visible')) {
                        offerImage3.val($thumbnail3.find('img').attr('src'));
                        deffers[2].resolve();
                    } else if (fileUploadControl3.files.length > 0) {
                        var file3 = fileUploadControl3.files[0],
                            fileName3 = file3.name;

                        var parseFile3 = new Parse.File(fileName3, file3);
                        parseFile3.save().then(function(image) {
                            offerImage3.val(image.url());
                            deffers[2].resolve();
                        }, function(error) {
                            console.log(error);
                        });
                    } else {
                        deffers[2].resolve();
                    }
                });

                $.when(promises[2]).then(function () {
                    if ($thumbnail4.is(':visible')) {
                        thumbnail.val($thumbnail4.find('img').attr('src'));
                        deffers[3].resolve();
                    } else if (thumbnailControl.files.length > 0) {
                        var file = thumbnailControl.files[0],
                            fileName = file.name;

                        var parseFile = new Parse.File(fileName, file);
                        parseFile.save().then(function(image) {
                            thumbnail.val(image.url());
                            deffers[3].resolve();
                        }, function(error) {
                            console.log(error);
                        });
                    } else {
                        deffers[3].resolve();
                    }
                });

                $.when(promises[3]).then(function () {
                    form.submit();
                });
            }
        });

        $('#form-field-date').datepicker();
    });
</script>
<% include ../../parts/foot %>