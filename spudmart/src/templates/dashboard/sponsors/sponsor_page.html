{% extends 'dashboard_base.html' %}

{% block content %}

    <div class="page-header">
        <h1>
            Dashboard <small><i class="icon-double-angle-right"></i> sponsor page</small>
        </h1>
    </div>

    <div class="content">
        <div id="entity-create">
            <form action="{{ upload_url }}" method="post" id="create-team-form" class="form-horizontal" enctype="multipart/form-data">
                <div class="control-group">
                    <label class="control-label" for="name">Name:</label>
                    <div class="controls">
                        <input tabindex="1" name="name" id="name"  value="{{form.name.value|default:"" }}"/>
                        <span class="input-required">*required</span>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="speciality">Speciality:</label>
                    <div class="controls">
                        <input tabindex="2" name="speciality" id="speciality" value="{{form.speciality.value|default:"" }}" />
                        <span class="input-required">*required</span>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="form-field-phone">Phone:</label>
                    <div class="controls">
                        <span class="input-icon input-icon-right">
                            <input tabindex="3" class="input-medium input-mask-phone" name="phone"
                                   id="form-field-phone" type="text" value="{{form.phone.value|default:"" }}" />
                            <i class="icon-phone icon-flip-horizontal icon-right"></i>
                        </span>
                        <span class="input-required">*required</span>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="form-field-fax">Fax:</label>
                    <div class="controls">
                        <span class="input-icon input-icon-right">
                            <input tabindex="4" class="input-medium input-mask-phone" name="fax"
                                   id="form-field-fax" type="text" value="{{form.fax.value|default:"" }}" />
                            <i class="icon-phone icon-flip-horizontal icon-right"></i>
                        </span>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="email">Email:</label>
                    <div class="controls">
                        <span class="input-icon input-icon-right">
                            <input tabindex="5" class="input-medium input-mask-email" id="email"
                                   name="email" type="email" placeholder="me@website.com"
                                   value="{{form.email.value|default:"" }}" />
                            <i class="icon-envelope"></i>
                        </span>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="form-field-website">Website:</label>
                    <div class="controls">
                        <span class="input-icon input-icon-right">
                            <input tabindex="6" class="input-medium input-mask-website" name="website"
                                   id="form-field-website" type="url" placeholder="http://www.website.com"
                                   value="{{form.website.value|default:"" }}" />
                            <i class="icon-bookmark icon-flip-horizontal icon-for-not-required-field"></i>
                        </span>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="form-field-video">Video:</label>
                    <div class="controls">
                        <span class="input-icon input-icon-right">
                            <input tabindex="7" class="input-medium input-mask-website" name="video"
                                   id="form-field-video" type="url" value="{{form.video.value|default:"" }}" />
                            <i class="icon-facetime-video icon-for-not-required-field"></i>
                        </span>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="description">Description:</label>
                    <div class="controls">
                        <textarea name="description" id="description" rows="5">{{form.description.value|default:"" }}</textarea>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label" for="location">Location:</label>
                    <div class="controls">
                        <input id="location" name="location" class="controls" type="text" placeholder="Enter a location">
                        <input id="infoLat" name="infoLat" type="hidden"
                            {% if lat %}value="{{ lat }}"{% endif %}>
                        <input id="infoLng" name="infoLng" type="hidden"
                            {% if lng %}value="{{ lng }}"{% endif %}>
                        <input id="infoWindow" name="infoWindow" type="hidden"
                            {% if info_window %}value="{{ info_window }}"{% endif %}>
                        <div id="map_canvas" class="google-map-canvas"></div>
                    </div>
                </div>

                {% if page and page.thumbnail %}
                    <div class="control-group thumbnail-container">
                        <label class="control-label" for="id_file">Current thumbnail:</label>
                        <div class="controls">
                            <img src="/file/serve/{{ page.thumbnail.id }}">
                        </div>
                    </div>
                {% endif %}

                <div class="control-group">
                    <label class="control-label" for="id_file">Thumbnail:</label>
                    <div class="controls">
                        {{ upload_form.file }}
                    </div>
                </div>

                {% if page %}
                    <div class="control-group">
                        <label class="control-label" for="offer-image-input1">Images:</label>
                        <div class="controls ace-files-container" name="offerImagesContainer">
                            {% for image in page.images %}
                                <div class="thumbnail"">
                                    {% if image %}
                                        <img src="/file/serve/{{ image }}"/>
                                        <div class="remove-image-container">
                                            <a href="/dashboard/sponsor/page/remove_image/{{ image }}" class="btn btn-small btn-danger">Remove</a>
                                        </div>
                                    {% else %}
                                        <img src="/media/img/red_plus_sign.png"/>
                                        <div class="remove-image-container">
                                            <a href="/dashboard/sponsor/page/add_image" class="btn btn-small btn-danger">Add</a>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                <div class="control-group">
                    <div class="controls">
                        <button type="submit" class="btn btn-danger">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

{% endblock content %}

{% block scripts %}
    <script src="/media/dashboard/js/jquery.validate.js"></script>
    <script src="/media/dashboard/js/additional-methods.min.js"></script>
    <script src="/media/dashboard/js/jquery.validate.spudder.rules.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ places_api_key }}&v=3.exp&sensor=false&libraries=places"></script>

    <!-- Google Maps initialization and configuration -->
    <script>
        function initialize() {
            function addPlaceChangedListener() {
                google.maps.event.addListener(autocomplete, 'place_changed', function () {
                    infowindow.close();
                    marker.setVisible(false);

                    var place = autocomplete.getPlace();
                    if (!place.geometry) return;

                    var location = place.geometry.location;

                    if (place.geometry.viewport) {
                        map.fitBounds(place.geometry.viewport);
                    } else {
                        map.setCenter(location);
                        map.setZoom(17);  // Why 17? Because it looks good.
                    }

                    marker.setPosition(location);
                    marker.setVisible(true);

                    var address = '';
                    if (place.address_components) {
                        address = [
                            (place.address_components[0] && place.address_components[0].short_name || ''),
                            (place.address_components[1] && place.address_components[1].short_name || ''),
                            (place.address_components[2] && place.address_components[2].short_name || '')
                        ].join(' ');
                    }

                    var infoWindowContent = '<div><strong>' + place.name + '</strong><br>' + address +
                            '<br><a href="http://maps.google.com/?q=' + encodeURIComponent(address) + '" target="_new">External map</a>';
                    infowindow.setContent(infoWindowContent);
                    infowindow.open(map, marker);

                    inputInfoWindow.value = infoWindowContent;
                    inputLat.value = location.A;
                    inputLng.value = location.k;
                });
            }

            function addKeyDownListener() {
                google.maps.event.addDomListener(input, 'keydown', function (event) { // Prevent form submit event on Enter
                    if (event.keyCode == 13) {
                        if (event.preventDefault) {
                            event.preventDefault();
                        } else {
                            event.cancelBubble = true;
                            event.returnValue = false;
                        }
                    }
                });
            }

            function placeStartMarker (address, mapInfo) {
                var geocoder = new google.maps.Geocoder(),
                    infoContent = mapInfo.split(';')[2];

                geocoder.geocode( { 'address': address}, function(results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        var location = results[0].geometry.location;

                        map.setCenter(location);
                        map.setZoom(13);

                        marker.setPosition(location);
                        marker.setVisible(true);

                        infowindow.setContent(infoContent);
                        input.value = address;
                        infowindow.open(map, marker);
                    }
                });
            }

            var mapOptions = {
                    zoom: 6, center: new google.maps.LatLng(-34.397, 150.644),
                        mapTypeControl: false, streetViewControl: false
                },
                canvas = document.getElementById('map_canvas'),
                map = new google.maps.Map(canvas, mapOptions),
                input = (document.getElementById('location')),
                inputLat = (document.getElementById('infoLat')),
                inputLng = (document.getElementById('infoLng')),
                inputInfoWindow = (document.getElementById('infoWindow'));

            addKeyDownListener();

            map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

            var autocomplete = new google.maps.places.Autocomplete(input);
            window.autocomplete = autocomplete;
            autocomplete.bindTo('bounds', map);

            var infowindow = new google.maps.InfoWindow(),
                marker = new google.maps.Marker({ map: map });

            addPlaceChangedListener();

            {% if page and page.location %}
                {% autoescape off %}
                placeStartMarker('{{ page.location }}', '{{ page.map_info }}');
                {% endautoescape %}
            {% endif %}
        }

        google.maps.event.addDomListener(window, 'load', initialize);
    </script>

    <script>
        $(document).ready(function () {
            var $form = $('form');

            $form.validate({
                rules: {
                    name: "required",
                    speciality: "required",
                    phone: { required: true, phoneUS: true },
                    fax: { phoneUS: true }
                },

                errorPlacement: function(error, element) {
                    error.appendTo( element.parent() );
                },
                submitHandler: function (form) {
                    var $formSubmit = $(form).find('button[type="submit"]');

                    $formSubmit.text('Saving...');
                    $formSubmit.attr('disabled', 'disabled');

                    form.submit();
                }
            });
        });
    </script>
{% endblock scripts %}