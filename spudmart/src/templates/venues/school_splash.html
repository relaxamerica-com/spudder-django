{% extends 'base.html' %}

{% load displays %}

{% block meta %}
<link rel="stylesheet" href="/media/dashboard/css/ace-file-input.css" />
{% endblock meta %}

{% block content %}
<div class="container clearfix" id="venue-view">
    <div class="row">
        <div class="span7">
            <h5 class="venue-header clearfix aligncenter"> {{ school.name }} </h5>
            
            <div class="row-fluid">
                <div class="span12 contents">
                    <div class="alert"></div>
                    <div id="venue-promo-video" class="active content">
                        <iframe width="560" height="315" src="//www.youtube.com/embed/H72B-GCMohs?rel=0"
                        style="display:block;margin:0 auto;"
                        frameborder="0"
                        allowfullscreen></iframe>
                    </div>
                </div>
            </div>
        </div>

        <div class="span5">
            <aside class="right-sidebar">
                <div class="widget offer-widget">
                    {% if request.user and head and request.user.pk == head.user.pk %}
                    <div class="row-fluid">
                        <div class="span6">                    
		                    <form method="post" enctype="multipart/form-data">
		                        <div class="alert"></div>
		                        <div class="edit-mode">
		                            <div class="btn btn-orange" id="save-name">
		                                Save
		                            </div>
		                        </div>
		                    </form>
                        </div>
                        
                        <div class="span6">
                            <div class="btn btn-orange pull-right" id="edit" style="margin:0 auto;">
                                Edit Mode
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="row-fluid edit-mode aligncenter">
                        <div class="span12">
                            <p>Show some school spirit and customize your page!</p>
                            <form method="post" enctype="multipart/form-data">
                                <label>Team Mascot: </label>
                                {% if school.mascot %}
                                    <input name="mascot" value="{{ school.mascot }}">
                                {% else %}
                                    <input name="mascot" value="Your School Mascot">
                                {% endif %}
                            </form>
                        </div>
                        
                    </div>
                    
                    <div class="row-fluid">
                        <div class="span12" >
                            {% if school.logo %}
                                <img id="venue-logo" src="/file/serve/{{ school.logo.id }}" />
                            {% else %}
                                <div class="logo-placeholder" style="margin:0 auto;">
                                    Your Logo Here
                                </div>
                            {% endif %} 
                        </div>
                    </div>
                    
                    <div class="row-fluid edit-mode">
                        <div class="span2"></div>
	                    <div class="span8 aligncenter">
	                        Upload a new logo: <input type="file" name="file" id="edit-logo" />
                        </div>
                        <div class="span2"></div>
                    </div>

                    <div class="row-fluid">

                        <div class="span8 details-header">
                            Join {{ school.name }}'s Campus Entrepenuer Recruiting Network (CERN) Team! 
                        </div>

                        <ul class="span4 social-network">
                            <li>
                                <a href="" target="_blank" data-placement="bottom" title="" data-original-title="Venue Facebook profile"> <i class="icon-facebook icon-square"></i> </a>
                            </li>

                            <li>
                                <a href="" target="_blank" data-placement="bottom" title="" data-original-title="Venue Twitter profile"> <i class="icon-twitter icon-square"></i> </a>
                            </li>

                            <li>
                                <a href="" target="_blank" rel="publisher" data-placement="bottom" title="" data-original-title="Venue Google+ profile"> <i class="icon-google-plus icon-square"></i> </a>
                            </li>

                        </ul>
                    </div>

                    <ul class="folio-detail offer-details">
                        <li>
                            <label>Team Size: </label> {{ school.num_students }} registered 
                            {% if school.mascot %}
                                {{ school.mascot }}
                            {% else %}
                                students
                            {% endif %} 
                        </li>

                        <li>
                            <label>School Reputation: </label> {{ school.get_rep }} points, Level {{ school.level }} 
                        </li>
                        
                        <li>
                            <label>Team Captain: </label>
                                {% if head %}
                                    {{ head.user }}
                                {% else %}
                                    Register now to be Team Captain!
                                {% endif %}
                        </li>
                        
                        
                          <p class="aligncenter"><label>Sign up now!</label></p>
                          <p>Joining with Amazon allows us to pay you for the work you do with CERN. Plus, it's easier than remembering another account.</p>
                          <p>If you don't have an Amazon account, you can create one using this link. Simply select the "I am a new customer" option.</p>
                    </ul>
                          
    <div class="accounts-form-body">
        <form class="form-horizontal" action="/accounts/login" id="registration-form" method="POST">
            {% if error %}
            <div class="alert alert-error"><%= error %></div>
            {% endif %}

            <input type="hidden" name="returnURL" {% if returnURL %}value="{{ returnURL }}"{% endif %}>

            <div class="control-group">
                <p class="aligncenter">
                    <a href="#" id="LoginWithAmazon">
                        <img border="0" alt="Login with Amazon"
                             src="https://images-na.ssl-images-amazon.com/images/G/01/lwa/btnLWA_gold_156x32.png"
                             width="156" height="32" />
                    </a>
                </p>
            </div>
        </form>
    </div>
	                
                </div>
            </aside>
        </div>
    </div>

</div>
{% endblock content %}

{% block scripts %}
<script type="text/javascript" src="/media/js/venues/utils.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=true&libraries=geometry"></script>
<script type="text/javascript" src="/media/js/google.map.js"></script>
<script type="text/javascript" src="/media/js/jquery.serialize.file.js"></script>
<script type="text/javascript" src="/media/dashboard/js/ace-elements.min.js"></script>
<script type="text/javascript" src="/media/dashboard/js/ace.min.js"></script>
<script type="text/javascript" src="/media/dashboard/js/jquery-ui-1.10.3.custom.min.js"></script>
<script type="text/javascript" src="/media/js/parseUri.js"></script>
<script type="text/javascript">
    window.venueName = "{{ venue.name }}";
    window.currentVenueLongitude = "{{ venue.longitude }}";
    window.currentVenueLatitude = "{{ venue.latitude }}";
    window.preloadedOrange = $('<img src="/media/img/ajax-loader-orange.gif" />');
    window.preloadedBlack = $('<img src="/media/img/ajax-loader-black.gif" />');
    window.isEditMode = false;
    window.currentSelectedSport = '{{ venue.sport }}';

    $(document).ready(function() {
        function checkReadyContentsCount() {
            return window.setInterval(function() {
                if ($('.buttons .ready').length == 12) {
                    $('#price-column').removeClass('hidden');
                    window.clearInterval(checked);
                }
            }, 1000);
        };
        
        var checked = checkReadyContentsCount();
        
        $('select[name="state"]').val('{{medical_address.state}}');

        $('#venue-pics-carousel, #playing-surface-carousel').carousel({
            interval : false
        });

        var editMode = $('.edit-mode'), viewMode = $('.view-mode'), buttons = $('.buttons'), icons = buttons.find('i');

        $('#edit').click(function() {
            if ($(this).html() == 'Show Mode') {
                editMode.hide();
                viewMode.show();
                buttons.addClass('no-border');
                $(this).html('Edit Mode');
                window.isEditMode = false;
            } else {
                editMode.show();
                viewMode.hide();
                buttons.removeClass('no-border');
                $(this).html('Show Mode');
                window.isEditMode = true;
            }
        });

        $(buttons).disableSelection();

        function show(element) {
            $('.contents > .active').removeClass('active');
            $(element).addClass('active');
            $(element).animate({
                'margin-left' : '0px'
            }, '1000');
            $(element).show();
        }

        function hide(elements) {
            $.each(elements, function() {
                $(this).css({
                    'margin-left' : '-1000px',
                    'display' : 'none'
                });
            });
        }


        icons.click(function() {
            var currentTab = $(this).parent().attr('openTab');

            $('.alert').hide();

            $('.buttons i.active').removeClass('active');

            hide($('.contents > div.content'));

            $(this).addClass('active');

            show(currentTab);

            if ($(this).hasClass('icon-map-marker')) {

                if (!$(this).hasClass('initialized')) {
                    initialize(window.isEditMode);
                }
            }

        });

        $('#save-parking-details').click(function() {
            var button = $(this), parkingDetails = $('[name="parking-details"]'), parkingTips = $('[name="parking-tips"]'), 
                dfd = saving($(this), $('.contents').find('.alert'), 'Parking details has been saved');

            var response = $.post('/venues/save_parking_details/{{ venue.id }}', {
                'parking-details' : parkingDetails.val(),
                'parking-tips' : parkingTips.val()
            });

            response.done(function() {
                $('.icon-truck').addClass('ready');
                
                $('#venue-parking-details').html(parkingDetails.val());
                $('#venue-parking-tips').html(parkingTips.val());
                
                dfd.resolve();
            });
        });
        
        $('.remove-pic').click(function() {
            var carousel = $(this).parent(),
                listType = $(this).attr('id'),
                active = carousel.find('.active'),
                fileURL = active.find('img').attr('src');
            
            var response = $.post('/venues/remove_pic/{{ venue.id }}', {
                'list_type' : listType,
                'file_url' : fileURL
            });
            
            carousel.carousel('next');
            active.remove();
            if (carousel.find('.item').length == 0) {
                carousel.hide();
            }
            showAlert($('.contents .alert'), 'Image has been removed', 'success', true);
        });

        $('#up-to-5-pics input, #playing-surface input').ace_file_input({
            style : 'well',
            btn_choose : 'Drop files here or click to choose',
            btn_change : null,
            no_icon : 'icon-cloud-upload',
            droppable : true,
            thumbnail : 'small'
            //, icon_remove:null//set null, to hide remove/reset button
            /**,before_change:function(files, dropped) {
             //Check an example below
             //or examples/file-upload.html
             return true;
             }*/
            /**,before_remove : function() {
             return true;
             }*/
            ,
            preview_error : function(filename, error_code) {
                //name of the file that failed
                //error_code values
                //1 = 'FILE_LOAD_FAILED',
                //2 = 'IMAGE_LOAD_FAILED',
                //3 = 'THUMBNAIL_FAILED'
                //alert(error_code);
            }
        });

        $('#edit-logo').ace_file_input({
            no_file : 'No File ...',
            btn_choose : 'Choose',
            btn_change : 'Change',
            droppable : false,
            onchange : null,
            thumbnail : false
        });

        $('#upload-up-to-5-pics').click(function() {
            var form = $(this).parents('form'), files = $(form).serializeFiles(), filesList = $(form).find('input')[0].files, dfd = saving($(this), $('.contents').find('.alert'), 'Venue pictures has been uploaded');

            $.get('/upload/get_upload_url', function(data) {
                $.ajax({
                    url : data,
                    data : files,
                    cache : false,
                    contentType : false,
                    processData : false,
                    type : 'POST',
                    success : function(data) {
                        var parsed = JSON.parse(data);

                        var response = $.post('/venues/save_venue_pics/{{ venue.id }}', {
                            'venue_pics' : parsed['uploaded_files']
                        });

                        response.done(function(data) {
                            dfd.resolve();
                            
                            var carousel = $('#up-to-5-pics .carousel');
                            
                            populateCarousel(parsed, carousel);
                            
                            $('.icon-camera-retro').addClass('ready');
                        });
                    }
                });
            });
        });
        
        function populateCarousel(parsed, carousel) {
            $.each(parsed['uploaded_files'], function() {
                var item = $('<div class="item"></div>'),
                    img = $('<img />');
                
                img.attr('src', this);
                if(carousel.find('.item').length == 0) {
                    item.addClass('active');
                }
                
                item.append(img);
                carousel.find('.carousel-inner').append(item);
            });
            
            carousel.removeClass('hidden');
            carousel.show();
            carousel.carousel().removeData();
            carousel.carousel({ interval: false });
        }

        $('#save-name').click(function() {
            var form = $(this).parents('form'), 
                files = $(form).serializeFiles(), 
                filesList = $(form).find('input')[0].files, 
                name = $(form).find('[name="name"]').val(), 
                akaName = $(form).find('[name="aka_name"]').val(), 
                dfd = saving($(this), $(form).find('.alert'), 'Venue basic information has been saved'),
                sport = $('[name="sport"]').val();

            $.get('/upload/get_upload_url', function(data) {
                $.ajax({
                    url : data,
                    data : files,
                    cache : false,
                    contentType : false,
                    processData : false,
                    type : 'POST',
                    success : function(data) {
                        var parsed = JSON.parse(data);

                        var response = $.post('/venues/save_logo_and_name/{{ venue.id }}', {
                            'logo' : parsed['uploaded_files'],
                            'name' : name,
                            'aka_name' : akaName,
                            'sport' : sport
                        });

                        response.done(function(data) {
                            window.currentSelectedSport;
                            
                            $('#venue-name, #venue-name2').html(name);
                            $('#venue-aka-name, #venue-aka-name2').html(akaName);
                            if (parsed['uploaded_files'].length > 0) {
                                $('#venue-logo, #venue-logo2').attr('src', parsed['uploaded_files'][0]);
                            }
                            
                            dfd.resolve();
                        });
                    }
                });
            });
        });

        $('#upload-playing-surface').click(function() {
            var form = $(this).parents('form'), 
                files = $(form).serializeFiles(), 
                filesList = $(form).find('input')[0].files, 
                dfd = saving($(this), $('.contents').find('.alert'), 'Playing surface pictures and details have been saved'),
                details = form.find('[name="details"]');

            $.get('/upload/get_upload_url', function(data) {
                $.ajax({
                    url : data,
                    data : files,
                    cache : false,
                    contentType : false,
                    processData : false,
                    type : 'POST',
                    success : function(data) {
                        var parsed = JSON.parse(data);

                        var response = $.post('/venues/save_playing_surface_pics/{{ venue.id }}', {
                            'playing_surface_pics' : parsed['uploaded_files'],
                            'playing_surface_details' : details.val()
                        });

                        response.done(function(data) {
                            dfd.resolve();
                            populateCarousel(parsed, $('#playing-surface-carousel'));
                            $('#venue-playing-surface-details').html(details.val());
                            $('.icon-eye-open').addClass('ready');
                        });
                    }
                });
            });
        });


        $('#save-video').click(function() {
            var textarea = $('#video form textarea'), dfd = saving($(this), $('.contents .alert'), 'Youtube video has been saved');

            var response = $.post('/venues/save_video/{{ venue.id }}', {
                'video' : textarea.val()
            });

            response.done(function() {
                dfd.resolve();
                $('#venue-video').html(textarea.val());
                $('.icon-facetime-video').addClass('ready');
            });
        });

        $('#save-restroom-details').click(function() {
            var textarea = $('#restroom-details form textarea'), dfd = saving($(this), $('.contents .alert'), 'Restroom details has been saved');

            var response = $.post('/venues/save_restroom_details/{{ venue.id }}', {
                'restroom_details' : textarea.val()
            });

            response.done(function() {
                dfd.resolve();
                $('#venue-restroom-details').html(textarea.val());
                $('.icon-female').addClass('ready');
            });
        });

        $('#save-concession-details').click(function() {
            var textarea = $('#concession-details form textarea'), dfd = saving($(this), $('.contents .alert'), 'Concession details has been saved');

            var response = $.post('/venues/save_concession_details/{{ venue.id }}', {
                'concession_details' : textarea.val()
            });

            response.done(function() {
                dfd.resolve();
                $('#venue-concession-details').html(textarea.val());
                $('.icon-food').addClass('ready');
            });
        });

        $('#save-admission-details').click(function() {
            var textarea = $('#admission-details form textarea'), dfd = saving($(this), $('.contents .alert'), 'Admission details has been saved');

            var response = $.post('/venues/save_admission_details/{{ venue.id }}', {
                'admission_details' : textarea.val()
            });

            response.done(function() {
                dfd.resolve();
                $('#venue-admission-details').html(textarea.val());
                $('.icon-ticket').addClass('ready');
            });
        });

        $('#save-shelter-details').click(function() {
            var textarea = $('#shelter-details form textarea'), dfd = saving($(this), $('.contents .alert'), 'Shelter details has been saved');

            var response = $.post('/venues/save_shelter_details/{{ venue.id }}', {
                'shelter_details' : textarea.val()
            });

            response.done(function() {
                dfd.resolve();
                $('#venue-shelter-details').html(textarea.val());
                $('.icon-umbrella').addClass('ready');
            });
        });

        $('#save-medical-details').click(function() {
            var textareaDetails = $('#medical-details form textarea[name="details"]'), 
                address = $('#medical-details form input[name="address"]'), 
                city = $('#medical-details form input[name="city"]'), 
                state = $('#medical-details form select[name="state"]'), 
                zip = $('#medical-details form input[name="zip"]'), 
                dfd = saving($(this), $('.contents .alert'), 'Medical details has been saved');

            var medicalAddress = address.val() + ', ' + city.val() + ', ' + state.val() + ', ' + zip.val();

            var response = $.post('/venues/save_medical_details/{{ venue.id }}', {
                'medical_details' : textareaDetails.val(),
                'medical_address' : medicalAddress
            });

            response.done(function() {
                dfd.resolve();
                $('#venue-medical-details').html(textareaDetails.val());
                $('#venue-medical-address').html(medicalAddress);
                $('.icon-medkit').addClass('ready');
                $('#venue-medical-address').attr('href', 'http://maps.google.com/?q=' + medicalAddress);
            });
        });

        $('#save-handicap-details').click(function() {
            var textarea = $('#handicap-details form textarea'), dfd = saving($(this), $('.contents .alert'), 'Handicap details has been saved');

            var response = $.post('/venues/save_handicap_details/{{ venue.id }}', {
                'handicap_details' : textarea.val()
            });

            response.done(function() {
                dfd.resolve();
                $('#venue-handicap-details').html(textarea.val());
                $('.fa-wheelchair').addClass('ready');
            });
        });

        $('#save-location').click(function() {
            var dfd = saving($(this), $('.contents .alert'), 'Location has been saved');

            var response = $.post('/venues/save_coordinates/{{ venue.id }}', {
                'latitude' : '' + window.map.getCenter().lat(),
                'longitude' : '' +  window.map.getCenter().lng()
            });

            response.done(function() {
                dfd.resolve();
                $('.buttons i.icon-map-marker').addClass('ready initialized');
            });
        });

        $('#prize-this-venue').click(function() {
            var priceInput = $('#price'), button = $(this), currentPrice = $('#current-price');

            currentPrice.hide();

            if ($(this).html() == 'Save') {
                var dfd = saving($(this), $(this).parent().find('.alert'), 'Price saved');
                var response = $.post('/venues/save_price/{{ venue.id }}', {
                    'price' : priceInput.val() ? priceInput.val() : '0'
                });

                response.done(function() {
                    dfd.resolve();
                    $(button).html('Price this Venue');
                    currentPrice.show();
                    priceInput.parent().css('display', 'none');
                });

            } else {
                priceInput.parent().css('display', 'table');
                $(this).html('Save');
            }
        });

    }); 
</script>
<script>
    function getURLParameter(name) {
        return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null
    }

    var loginWithAmazon = document.getElementById('LoginWithAmazon'),
        next = getURLParameter('next'),
        returnUrl = '{{ base_url }}/accounts/login/amazon';

    if (next) returnUrl += '?next=' + next;

    if (loginWithAmazon) {
        loginWithAmazon.onclick = function() {
            options = { scope : 'profile' };
            amazon.Login.authorize(options, returnUrl);
            return false;
        };
    }
</script>
{% endblock scripts %}
