<% include ../../parts/head %>

<link rel="stylesheet" href="/media/dashboard/css/chosen.css" />

<% include ../../parts/bodyStart %>

<div id="entity-create">
    <p class="head">
        <i class="icon-briefcase"></i> Sponsorship Offer:
    </p>

    <form action="/dashboard/teams/<%= teamID %>/offers/<%= offer.id %>/edit" method="post" id="create-team-form" class="form-horizontal">
        <div class="control-group">
            <label class="control-label" for="title">Title:</label>
            <div class="controls">
                <input tabindex="1" name="title" id="title" value="<%= offer.get('title') %>"/>
                <span class="input-required">*required</span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="donation">Donations:</label>
            <div class="controls">
                <input tabindex="2" name="donation" id="donation" value="<%= offer.get('donation') %>" disabled/>
                <span class="input-required">*required</span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="form-field-phone">Phone:</label>
            <div class="controls">
                <span class="input-icon input-icon-right">
                    <input tabindex="3" class="input-medium input-mask-phone" name="phone" id="form-field-phone" type="text" value="<%= offer.get('phone') %>">
                    <i class="icon-phone icon-flip-horizontal icon-right"></i>
                </span>
                <span class="input-required">*required</span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="form-field-website">Website:</label>
            <div class="controls">
                <span class="input-icon input-icon-right">
                    <input tabindex="4" class="input-medium input-mask-website" name="website" id="form-field-website" type="url" value="<%= offer.get('website') %>" placeholder="http://www.website.com">
                    <i class="icon-bookmark icon-flip-horizontal icon-for-not-required-field"></i>
                </span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="quantity">Quantity available:</label>
            <div class="controls">
                <input tabindex="5" name="quantity" id="quantity" value="<%= offer.get('quantity') %>"/>
                <span class="input-required">*required</span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="form-field-video">Video</label>
            <div class="controls">
                <span class="input-icon input-icon-right">
                    <input tabindex="6" class="input-medium input-mask-website" name="video" id="form-field-video" type="url" value="<%= offer.get('video') %>">
                    <i class="icon-bookmark  icon-flip-horizontal icon-for-not-required-field"></i>
                </span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="form-field-date">End date:</label>
            <div class="controls">
                <div class="input-append">
                    <input class="input-small date-picker" name="endDate" id="form-field-date" data-date-format="dd-mm-yyyy" placeholder="dd-mm-yyyy" type="text"  value="<%= offer.get('endDate') %>">
                    <span class="add-on">
                        <i class="icon-calendar" title="" data-original-title="You don't have to give this but won't be able to claim roles such as players or coaches if you don't."></i>
                    </span>
                </div>
                <span class="input-required">*required</span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="details">Details:</label>
            <div class="controls">
                <textarea name="details" id="details" rows="5"><%= offer.get('details') %></textarea>
                <span class="input-required">*required</span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="offer-image-input1">Images:</label>
            <div class="controls">
                <% if (offer.get('images').length) { %>
                    <% offer.get('images').forEach(function(image, index) { %>
                        <div class="thumbnail" data-thumbnail-index="<%= index + 1 %>">
                            <img src="<%= image %>"/>
                            <div class="remove-image-container">
                                <a href="#" class="btn btn-small btn-danger">Remove</a>
                            </div>
                        </div>
                    <% }) %>
                <% } %>

                <input type="hidden" name="offerImage1" />
                <input type="file" id="offer-image-input1" name="offerImageInput1" class="file-upload-input" accept="image/*" />
                <input type="hidden" name="offerImage2" />
                <input type="file" id="offer-image-input2" name="offerImageInput2" class="file-upload-input" accept="image/*" />
                <input type="hidden" name="offerImage3" />
                <input type="file" id="offer-image-input3" name="offerImageInput3" class="file-upload-input" accept="image/*" />
                <div class="save-btn-container">
                    <div class="save-btn-inner-container">
                        <button class="btn btn-danger" type="submit">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<% include ../../parts/scripts %>

<script src="/media/dashboard/js/jquery.validate.js"></script>
<script src="/media/dashboard/js/jquery.validate.spudder.rules.js"></script>
<script src="/media/dashboard/js/additional-methods.min.js"></script>
<script src="/media/dashboard/js/date-time/bootstrap-datepicker.min.js"></script>
<script src="/media/dashboard/js/teams/helpers.js"></script>
<script src="/media/js/parse.js"></script>

<script>
    $(window).load(function () {
        <% if (offer.get('images').length) { %>
            $('.ace-file-input, .save-btn-container').addClass('below-thumbnail');

            $('.thumbnail').each(function () {
                var $removeButton = $(this).find('a'),
                    index = parseInt($(this).data('thumbnail-index'), 10),
                    $aceFileInput = $('#offer-image-input' + index).parent();

                $aceFileInput.hide();

                $removeButton.click(function () {
                    var $self = $(this),
                        $thumbnail = $self.parent().parent(),
                        index = parseInt($thumbnail.data('thumbnail-index'), 10),
                        $aceFileInput = $('#offer-image-input' + index).parent();

                    $thumbnail.hide();
                    $aceFileInput.show();

                    if ($('.thumbnail:visible').length == 0) {
                        $('.ace-file-input, .save-btn-container').removeClass('below-thumbnail');
                    }
                });
            });
        <% } %>
    });

    $(document).ready(function () {
        Parse.initialize('<%= keys.appId %>', '<%= keys.jsKey %>');

        var $form = $('#create-team-form');

        $form.validate({
            rules: {
                title: "required",
                phone: "required",
                quantity: { required: true, positiveInteger: true },
                donation: { required: true, positiveInteger: true },
                endDate: "required",
                offerImageInput1: { extension: "gif|png|jpg|jpeg" },
                offerImageInput2: { extension: "gif|png|jpg|jpeg" },
                offerImageInput3: { extension: "gif|png|jpg|jpeg" }
            },
            errorPlacement: function(error, element) {
                error.appendTo( element.parent() );
            },
            submitHandler: function (form) {
                var $formSubmit = $(form).find('button[type="submit"]');

                $formSubmit.text('Saving...');
                $formSubmit.attr('disabled', 'disabled');

                var offerImage1 = $(form).find('input[name="offerImage1"]'),
                    fileUploadControl1 = $("#offer-image-input1")[0],
                    $thumbnail1 = $(form).find('.thumbnail[data-thumbnail-index="1"]'),
                    offerImage2 = $(form).find('input[name="offerImage2"]'),
                    fileUploadControl2 = $("#offer-image-input2")[0],
                    $thumbnail2 = $(form).find('.thumbnail[data-thumbnail-index="2"]'),
                    offerImage3 = $(form).find('input[name="offerImage3"]'),
                    fileUploadControl3 = $("#offer-image-input3")[0],
                    $thumbnail3 = $(form).find('.thumbnail[data-thumbnail-index="3"]');

                var deffers = [ new jQuery.Deferred(), new jQuery.Deferred(), new jQuery.Deferred() ],
                    promises =  [deffers[0].promise(), deffers[1].promise(), deffers[2].promise() ];

                if ($thumbnail1.is(':visible')) {
                    offerImage1.val($thumbnail1.find('img').attr('src'));
                    deffers[0].resolve();
                } else if (fileUploadControl1.files.length > 0) {
                    var file1 = fileUploadControl1.files[0],
                        fileName1 = file1.name;

                    var parseFile1 = new Parse.File(fileName1, file1);
                    parseFile1.save().then(function(image) {
                        offerImage1.val(image.url());
                        deffers[0].resolve();
                    }, function(error) {
                        console.log(error);
                    });
                } else {
                    deffers[0].resolve();
                }

                $.when(promises[0]).then(function () {
                    if ($thumbnail2.is(':visible')) {
                        offerImage2.val($thumbnail2.find('img').attr('src'));
                        deffers[1].resolve();
                    } else  if (fileUploadControl2.files.length > 0) {
                        var file2 = fileUploadControl2.files[0],
                            fileName2 = file2.name;

                        var parseFile2 = new Parse.File(fileName2, file2);
                        parseFile2.save().then(function(image) {
                            offerImage2.val(image.url());
                            deffers[1].resolve();
                        }, function(error) {
                            console.log(error);
                        });
                    } else {
                        deffers[1].resolve();
                    }
                });

                $.when(promises[1]).then(function () {
                    if ($thumbnail3.is(':visible')) {
                        offerImage3.val($thumbnail3.find('img').attr('src'));
                        deffers[2].resolve();
                    } else if (fileUploadControl3.files.length > 0) {
                        var file3 = fileUploadControl3.files[0],
                            fileName3 = file3.name;

                        var parseFile3 = new Parse.File(fileName3, file3);
                        parseFile3.save().then(function(image) {
                            offerImage3.val(image.url());
                            deffers[2].resolve();
                        }, function(error) {
                            console.log(error);
                        });
                    } else {
                        deffers[2].resolve();
                    }
                });

                $.when(promises[2]).then(function () {
                    form.submit();
                });
            }
        });

        $('#form-field-date').datepicker();
    });
</script>
<% include ../../parts/foot %>