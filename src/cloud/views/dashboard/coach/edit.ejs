<% include ../parts/head %>

<link rel="stylesheet" href="/media/dashboard/css/chosen.css" />

<% include ../parts/bodyStart %>

<% if (found) { %>
<div id="entity-create">
    <table class="header-table">
        <tr>
            <td class="image-cell">
                <% if (entity.get('profileImageThumb')) { %>
                	<img src="<%= entity.get('profileImageThumb') %>" />
                <% } else { %>
                	<i class="icon-bullhorn"></i>
                <% } %>
            </td>
            <td>
                <p class="head">
                    <%= entity.get('name') %>
                </p>
                <p class="location"><%= entity.get('location') %></p>
            </td>
        </tr>
    </table>

    <h3>Update this Coach:</h3>

    <form action="/dashboard/editEntity/Coach/<%= entity.id %>" method="post" id="create-coach-form" class="form-horizontal">
    	
    	<div class="control-group">
            <label class="control-label" for="name">Name (Nickname):</label>
            <div class="controls">
                <input name="name" id="name" value="<%= entity.get('name') %>" tabindex="1" />
                <span class="input-required">*required</span>
                <input tabindex="16" type="checkbox" name="hide-publicly" <% if (entity.get('isDisplayPublicly') == false) { %>checked="checked"<% }  %>/> <span class="hide-publicly-text">Do NOT display publicly</span>
            </div>
    	</div>
    	
    	<div class="control-group">
            <label class="control-label" for="name">Name (Public):</label>
            <div class="controls">
                <input tabindex="3" name="publicName" id="publicName" value="<%= entity.get('publicName') %>" />
            </div>
    	</div>
    	
    	<div class="control-group">
            <label class="control-label" for="location">Home Zip:</label>
            <div class="controls">
                <input name="location" id="location" value="<%= entity.get('location') %>" tabindex="4" />
                <span class="input-required" title="But never displayed, simply used to speed search">*required</span>
            </div>
    	</div>
    	
    	<div class="control-group">
            <label class="control-label" for="team">Team:</label>
            <div class="controls">
           	 	<%= getValueOrEmpty( entity.team ) %>
            </div>
    	</div>
    	
    	<div class="control-group">
            <label class="control-label" for="sport">Sport:</label>
            <div class="controls">
                <select name="sport" tabindex="5">
                    <% if (entity.get('sport') == 'football') { %>
	                    <option value="football" selected>Football</option>
	                    <option value="soccer">Soccer</option>
                    <% } else { %>
	                    <option value="football">Football</option>
	                    <option value="soccer" selected>Soccer</option>
                    <% } %>
                </select>
            </div>
    	</div>
    	
    	<div class="control-group">
            <label class="control-label" for="admins">Admins:</label>
            <div class="controls" id="admins-controls">
                <input tabindex="6" name="admins" id="admins" placeholder="Enter emails..."  value="<%= getValueOrEmpty( entity.get('adminsEmails') ) %>" />
            </div>
    	</div>
    	
    	<div class="control-group">
            <label class="control-label" for="contact">Coach Contact Details:</label>
            <div class="controls">
                <input tabindex="7" name="contact" id="contact" value="<%= getValueOrEmpty( entity.get('contact') ) %>" />
            </div>
    	</div>
    	
    	<div class="control-group">
            <label class="control-label" for="profile">Coach Profile:</label>
            <div class="controls">
                <textarea tabindex="8" name="profile" rows="2" id="profile"><%= entity.get('profile') %></textarea>
            </div>
    	</div>
    	
    	<div class="control-group">
            <label class="control-label" for="profile-picture-input">Profile Picture:</label>
            <div class="controls">
                <input type="hidden" name="profileImageThumb" value="<%= entity.get('profileImageThumb') %>" />
            	<input tabindex="9" type="file" id="profile-picture-input" accept="image/*" />
            </div>
    	</div>
    	
        <h4 class="header orange bolder smaller">Information</h4>
        <div class="control-group">
            <label class="control-label" for="form-field-website">Website</label>

            <div class="controls">
            <span class="input-icon input-icon-right">
                <input tabindex="10" name="website" value="<%= getValueOrEmpty(entity.get('website')) %>" id="form-field-website" type="url" placeholder="http://www.website.com">
                <i class="icon-bookmark icon-for-not-required-field"></i>
            </span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="form-field-email">Email</label>

            <div class="controls">
            <span class="input-icon input-icon-right">
                <input tabindex="11" name="email" value="<%= getValueOrEmpty(entity.get('email')) %>" id="form-field-email"type="email" placeholder="me@website.com">
                <i class="icon-envelope icon-for-not-required-field"></i>
            </span>
            </div>
        </div>

        <h4 class="header orange bolder smaller">Social</h4>
        <div class="control-group">
            <label class="control-label" for="form-field-facebook">Facebook</label>

            <div class="controls">
                <span class="input-icon">
                <input tabindex="12" name="facebook" value="<%= getValueOrEmpty(entity.get('facebook')) %>" id="form-field-facebook" type="url">
                <i class="icon-facebook"></i>
            </span>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label" for="form-field-twitter">Twitter</label>

            <div class="controls">
            <span class="input-icon">
                <input tabindex="13" value="<%= getValueOrEmpty(entity.get('twitter')) %>" name="twitter" id="form-field-twitter" type="url">
                <i class="icon-twitter"></i>
            </span>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label" for="form-field-gplus">Google+</label>

            <div class="controls">
            <span class="input-icon">
                <input tabindex="14" value="<%= getValueOrEmpty(entity.get('googlePlus')) %>" name="googlePlus" id="form-field-gplus" type="url">
                <i class="icon-google-plus"></i>
            </span>
            </div>
        </div>
		<div class="control-group">
			<div class="controls">
        		<button tabindex="15" class="btn btn-orange" type="submit">Save</button>
        	</div>
   		</div>
    </form>
</div>
<% } else { %>
	<p>Coach with provided ID not found!</p>
<% } %>

<% include ../parts/scripts %>

<% if (found) { %>
<script src="/media/dashboard/js/jquery.validate.js"></script>
<script src="/media/dashboard/js/checkEmailsExists.js"></script>
<script src="/media/dashboard/js/jquery.validate.spudder.rules.js"></script>
<script src="/media/dashboard/js/additional-methods.min.js"></script>
<script src="/media/js/parse.js"></script>
<script src="/media/dashboard/js/bootstrap-tag.min.js"></script>

<script>
    $(document).ready(function () {
        Parse.initialize('<%= keys.appId %>', '<%= keys.jsKey %>');

        var $form = $('#create-coach-form');

        $form.validate({
            rules: {
                name: "required",
                location: "required",
                picture: {
                    extension: "gif|png|jpg|jpeg"
                },
                admins: {
                	checkEmailsExists: true	
                }
            },
            messages: {
                name: "A coach name is required",
                location: "A coach location is required"
            },
            errorPlacement: function(error, element) {
            	if ( element.attr('name') == 'admins' ) {
            		error.appendTo( element.parent().parent() );
            	} else {
	                error.appendTo( element.parent() );
            	}
            },
            onkeyup: false,
            onfocus: false,
            onclick: false,
            submitHandler: function (form) {
                var $formSubmit = $(form).find('button[type="submit"]');
                $formSubmit.text('Saving...');
                $formSubmit.attr('disabled', 'disabled');

                var dfd = new jQuery.Deferred(),
                    promise = dfd.promise();

                var pictureURL = $form.find('input[name="profileImageThumb"]'),
                    fileUploadControl = $("#profile-picture-input")[0];

                if (fileUploadControl.files.length > 0) {
                    var file = fileUploadControl.files[0],
                        name = file.name;

                    var parseFile = new Parse.File(name, file);
                    parseFile.save().then(function(image) {
                        pictureURL.val(image.url());
                        dfd.resolve();
                    }, function(error) {
                        $formSubmit.text('Save');
                        $formSubmit.removeAttr('disabled');
                        console.log(error);
                    });
                } else {
                    dfd.resolve();
                }

                $.when(promise).then(function () {
                    form.submit();
                });
            }
        });

        $('#profile-picture-input').ace_file_input({
            no_file:'No File ...',
            btn_choose:'Choose',
            btn_change:'Select',
            droppable: false,
            onchange: null,
            thumbnail: true,
            whitelist: 'gif|png|jpg|jpeg',
            blacklist: 'exe|php'
        });
        
        $("#entity-create .input-required").tooltip({
			hide: {
				effect: "explode",
				delay: 2500
			},
			show: {
				effect: "slideDown",
				delay: 2500
			}
		});
        
        $('#admins').tag({ placeholder: $('#admins').attr('placeholder'), name: $('#admins').attr('name'), tabindex: $('#admins').attr('tabindex') });
        $('#admins-controls').click(function(e) {
        	if ( $(e.target).hasClass('close') ) {
        		var email = $(e.target).parent()[0].firstChild.data;
       			$.post('/dashboard/removeAdmin/Coach/<%= entity.id %>', {'adminEmail' : email });
        	}
        });

    });
</script>
<% } %>

<% include ../parts/foot %>